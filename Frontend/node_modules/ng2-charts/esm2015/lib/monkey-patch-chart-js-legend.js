/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
// tslint:disable:variable-name
/** @type {?} */
const helpers = Chart.helpers;
/** @type {?} */
const defaults = Chart.defaults;
/** @type {?} */
const valueOrDefault = helpers.valueOrDefault;
/**
 * @param {?} labelOpts
 * @param {?} fontSize
 * @return {?}
 */
function getBoxWidth(labelOpts, fontSize) {
    return labelOpts.usePointStyle && labelOpts.boxWidth > fontSize ?
        fontSize :
        labelOpts.boxWidth;
}
/**
 * @return {?}
 */
function fit() {
    /** @type {?} */
    const me = this;
    /** @type {?} */
    const opts = me.options;
    /** @type {?} */
    const labelOpts = opts.labels;
    /** @type {?} */
    const display = opts.display;
    /** @type {?} */
    const ctx = me.ctx;
    /** @type {?} */
    const labelFont = helpers.options._parseFont(labelOpts);
    /** @type {?} */
    const fontSize = labelFont.size;
    // Reset hit boxes
    /** @type {?} */
    const hitboxes = me.legendHitBoxes = [];
    /** @type {?} */
    const minSize = me.minSize;
    /** @type {?} */
    const isHorizontal = me.isHorizontal();
    if (isHorizontal) {
        minSize.width = me.maxWidth; // fill all the width
        minSize.height = display ? 10 : 0;
    }
    else {
        minSize.width = display ? 10 : 0;
        minSize.height = me.maxHeight; // fill all the height
    }
    /** @type {?} */
    const getMaxLineWidth = (/**
     * @param {?} textLines
     * @return {?}
     */
    textLines => {
        return textLines.map((/**
         * @param {?} textLine
         * @return {?}
         */
        textLine => {
            return ctx.measureText(textLine).width;
        })).reduce((/**
         * @param {?} acc
         * @param {?} v
         * @return {?}
         */
        (acc, v) => {
            return v > acc ? v : acc;
        }), 0);
    });
    // Increase sizes here
    if (display) {
        ctx.font = labelFont.string;
        if (isHorizontal) {
            // Labels
            // Width of each line of legend boxes. Labels wrap onto multiple lines when there are too many to fit on one
            /** @type {?} */
            const lineWidths = me.lineWidths = [0];
            /** @type {?} */
            let maxHeight = 0;
            /** @type {?} */
            let totalHeight = 0;
            ctx.textAlign = 'left';
            ctx.textBaseline = 'top';
            helpers.each(me.legendItems, (/**
             * @param {?} legendItem
             * @param {?} i
             * @return {?}
             */
            (legendItem, i) => {
                /** @type {?} */
                let width;
                /** @type {?} */
                let height;
                /** @type {?} */
                let grossHeight;
                if (helpers.isArray(legendItem.text)) {
                    width = getMaxLineWidth(legendItem.text);
                    height = fontSize * legendItem.text.length;
                    grossHeight = height;
                }
                else {
                    width = ctx.measureText(legendItem.text).width;
                    height = fontSize;
                    grossHeight = height + labelOpts.padding;
                }
                width += getBoxWidth(labelOpts, fontSize) + (fontSize / 2);
                if (grossHeight > maxHeight) {
                    maxHeight = grossHeight;
                }
                if (lineWidths[lineWidths.length - 1] + width + 2 * labelOpts.padding > minSize.width) {
                    totalHeight += maxHeight;
                    maxHeight = 0;
                    lineWidths[lineWidths.length - (i > 0 ? 0 : 1)] = 0;
                }
                // Store the hitbox width and height here. Final position will be updated in `draw`
                hitboxes[i] = {
                    left: 0,
                    top: 0,
                    width,
                    height,
                };
                lineWidths[lineWidths.length - 1] += width + labelOpts.padding;
            }));
            minSize.height += totalHeight + maxHeight;
        }
        else {
            /** @type {?} */
            const vPadding = labelOpts.padding;
            /** @type {?} */
            const columnWidths = me.columnWidths = [];
            /** @type {?} */
            const columnHeights = me.columnHeights = [];
            /** @type {?} */
            let totalWidth = labelOpts.padding;
            /** @type {?} */
            let currentColWidth = 0;
            /** @type {?} */
            let currentColHeight = 0;
            helpers.each(me.legendItems, (/**
             * @param {?} legendItem
             * @param {?} i
             * @return {?}
             */
            (legendItem, i) => {
                /** @type {?} */
                let itemWidth;
                /** @type {?} */
                let height;
                if (helpers.isArray(legendItem.text)) {
                    itemWidth = getMaxLineWidth(legendItem.text);
                    height = fontSize * legendItem.text.length;
                }
                else {
                    itemWidth = ctx.measureText(legendItem.text).width;
                    height = fontSize;
                }
                itemWidth += getBoxWidth(labelOpts, fontSize) + (fontSize / 2);
                // If too tall, go to new column
                if (i > 0 && currentColHeight + fontSize + 2 * vPadding > minSize.height) {
                    totalWidth += currentColWidth + labelOpts.padding;
                    columnWidths.push(currentColWidth); // previous column width
                    columnHeights.push(currentColHeight);
                    currentColWidth = 0;
                    currentColHeight = 0;
                }
                // Get max width
                currentColWidth = Math.max(currentColWidth, itemWidth);
                currentColHeight += fontSize + vPadding;
                // Store the hitbox width and height here. Final position will be updated in `draw`
                hitboxes[i] = {
                    left: 0,
                    top: 0,
                    width: itemWidth,
                    height
                };
            }));
            totalWidth += currentColWidth;
            columnWidths.push(currentColWidth);
            columnHeights.push(currentColHeight);
            minSize.width += totalWidth;
        }
    }
    me.width = minSize.width;
    me.height = minSize.height;
}
/**
 * @param {?} vm
 * @param {?} align
 * @return {?}
 */
function getAlignedX(vm, align) {
    return align === 'center'
        ? vm.x + vm.width / 2
        : align === 'right'
            ? vm.x + vm.width - vm.xPadding
            : vm.x + vm.xPadding;
}
/**
 * @return {?}
 */
function draw() {
    /** @type {?} */
    const me = this;
    /** @type {?} */
    const opts = me.options;
    /** @type {?} */
    const labelOpts = opts.labels;
    /** @type {?} */
    const globalDefaults = defaults.global;
    /** @type {?} */
    const defaultColor = globalDefaults.defaultColor;
    /** @type {?} */
    const lineDefault = globalDefaults.elements.line;
    /** @type {?} */
    const legendHeight = me.height;
    /** @type {?} */
    const columnHeights = me.columnHeights;
    /** @type {?} */
    const legendWidth = me.width;
    /** @type {?} */
    const lineWidths = me.lineWidths;
    if (opts.display) {
        /** @type {?} */
        const ctx = me.ctx;
        /** @type {?} */
        const fontColor = valueOrDefault(labelOpts.fontColor, globalDefaults.defaultFontColor);
        /** @type {?} */
        const labelFont = helpers.options._parseFont(labelOpts);
        /** @type {?} */
        const fontSize = labelFont.size;
        /** @type {?} */
        let cursor;
        // Canvas setup
        ctx.textAlign = 'left';
        ctx.textBaseline = 'middle';
        ctx.lineWidth = 0.5;
        ctx.strokeStyle = fontColor; // for strikethrough effect
        ctx.fillStyle = fontColor; // render in correct colour
        ctx.font = labelFont.string;
        /** @type {?} */
        const boxWidth = getBoxWidth(labelOpts, fontSize);
        /** @type {?} */
        const hitboxes = me.legendHitBoxes;
        /** @type {?} */
        const maxHeight = hitboxes.map((/**
         * @param {?} x
         * @return {?}
         */
        x => {
            return x.height;
        })).reduce((/**
         * @param {?} acc
         * @param {?} v
         * @return {?}
         */
        (acc, v) => {
            return v > acc ? v : acc;
        }), 0);
        // current position
        /** @type {?} */
        const drawLegendBox = (/**
         * @param {?} x
         * @param {?} y
         * @param {?} legendItem
         * @return {?}
         */
        (x, y, legendItem) => {
            if (isNaN(boxWidth) || boxWidth <= 0) {
                return;
            }
            // Set the ctx for the box
            ctx.save();
            /** @type {?} */
            const lineWidth = valueOrDefault(legendItem.lineWidth, lineDefault.borderWidth);
            ctx.fillStyle = valueOrDefault(legendItem.fillStyle, defaultColor);
            ctx.lineCap = valueOrDefault(legendItem.lineCap, lineDefault.borderCapStyle);
            ctx.lineDashOffset = valueOrDefault(legendItem.lineDashOffset, lineDefault.borderDashOffset);
            ctx.lineJoin = valueOrDefault(legendItem.lineJoin, lineDefault.borderJoinStyle);
            ctx.lineWidth = lineWidth;
            ctx.strokeStyle = valueOrDefault(legendItem.strokeStyle, defaultColor);
            if (ctx.setLineDash) {
                // IE 9 and 10 do not support line dash
                ctx.setLineDash(valueOrDefault(legendItem.lineDash, lineDefault.borderDash));
            }
            if (opts.labels && opts.labels.usePointStyle) {
                // Recalculate x and y for drawPoint() because its expecting
                // x and y to be center of figure (instead of top left)
                /** @type {?} */
                const radius = boxWidth * Math.SQRT2 / 2;
                /** @type {?} */
                const centerX = x + boxWidth / 2;
                /** @type {?} */
                const centerY = y + fontSize / 2;
                // Draw pointStyle as legend symbol
                helpers.canvas.drawPoint(ctx, legendItem.pointStyle, radius, centerX, centerY);
            }
            else {
                // Draw box as legend symbol
                if (lineWidth !== 0) {
                    ctx.strokeRect(x, y, boxWidth, fontSize);
                }
                ctx.fillRect(x, y, boxWidth, fontSize);
            }
            ctx.restore();
        });
        /** @type {?} */
        const drawStrikeThrough = (/**
         * @param {?} x
         * @param {?} y
         * @param {?} w
         * @return {?}
         */
        (x, y, w) => {
            ctx.beginPath();
            ctx.lineWidth = 2;
            ctx.moveTo(x, y);
            ctx.lineTo(x + w, y);
            ctx.stroke();
        });
        /** @type {?} */
        const drawCrossOver = (/**
         * @param {?} x
         * @param {?} y
         * @param {?} w
         * @param {?} h
         * @return {?}
         */
        (x, y, w, h) => {
            ctx.beginPath();
            ctx.lineWidth = 2;
            ctx.moveTo(x, y);
            ctx.lineTo(x + w, y + h);
            ctx.moveTo(x, y + h);
            ctx.lineTo(x + w, y);
            ctx.stroke();
        });
        /** @type {?} */
        const fillText = (/**
         * @param {?} x
         * @param {?} y
         * @param {?} legendItem
         * @param {?} textWidth
         * @return {?}
         */
        (x, y, legendItem, textWidth) => {
            /** @type {?} */
            const halfFontSize = fontSize / 2;
            /** @type {?} */
            const xLeft = boxWidth + halfFontSize + x;
            /** @type {?} */
            const yMiddle = y + halfFontSize;
            if (helpers.isArray(legendItem.text)) {
                helpers.each(legendItem.text, (/**
                 * @param {?} textLine
                 * @param {?} index
                 * @return {?}
                 */
                (textLine, index) => {
                    /** @type {?} */
                    const lineOffset = index * fontSize;
                    ctx.fillText(textLine, xLeft, yMiddle + lineOffset);
                }));
            }
            else {
                ctx.fillText(legendItem.text, xLeft, yMiddle);
            }
            if (legendItem.hidden) {
                if (helpers.isArray(legendItem.text)) {
                    drawCrossOver(xLeft, yMiddle, textWidth, (legendItem.text.length - 1) * (fontSize - 1));
                }
                else {
                    drawStrikeThrough(xLeft, yMiddle, textWidth);
                }
            }
        });
        /** @type {?} */
        const alignmentOffset = (/**
         * @param {?} dimension
         * @param {?} blockSize
         * @return {?}
         */
        (dimension, blockSize) => {
            switch (opts.align) {
                case 'start':
                    return labelOpts.padding;
                case 'end':
                    return dimension - blockSize;
                default: // center
                    return (dimension - blockSize + labelOpts.padding) / 2;
            }
        });
        // Horizontal
        /** @type {?} */
        const isHorizontal = me.isHorizontal();
        if (isHorizontal) {
            cursor = {
                x: me.left + alignmentOffset(legendWidth, lineWidths[0]),
                y: me.top + labelOpts.padding,
                line: 0
            };
        }
        else {
            cursor = {
                x: me.left + labelOpts.padding,
                y: me.top + alignmentOffset(legendHeight, columnHeights[0]),
                line: 0
            };
        }
        /** @type {?} */
        const itemHeight = maxHeight;
        helpers.each(me.legendItems, (/**
         * @param {?} legendItem
         * @param {?} i
         * @return {?}
         */
        (legendItem, i) => {
            /** @type {?} */
            let textWidth;
            /** @type {?} */
            let boxTopOffset;
            if (helpers.isArray(legendItem.text)) {
                textWidth = legendItem.text.map((/**
                 * @param {?} textLine
                 * @return {?}
                 */
                textLine => {
                    return ctx.measureText(textLine).width;
                })).reduce((/**
                 * @param {?} acc
                 * @param {?} v
                 * @return {?}
                 */
                (acc, v) => {
                    return v > acc ? v : acc;
                }), 0);
                boxTopOffset = fontSize / 2 * (legendItem.text.length - 1);
            }
            else {
                textWidth = ctx.measureText(legendItem.text).width;
                boxTopOffset = 0;
            }
            /** @type {?} */
            const width = boxWidth + (fontSize / 2) + textWidth;
            /** @type {?} */
            let x = cursor.x;
            /** @type {?} */
            const topOffset = Math.trunc((maxHeight - hitboxes[i].height) / 2);
            /** @type {?} */
            let y = cursor.y + topOffset;
            // Use (me.left + me.minSize.width) and (me.top + me.minSize.height)
            // instead of me.right and me.bottom because me.width and me.height
            // may have been changed since me.minSize was calculated
            if (isHorizontal) {
                if (i > 0 && x + width + labelOpts.padding > me.left + me.minSize.width) {
                    y = cursor.y += itemHeight;
                    cursor.line++;
                    x = cursor.x = me.left + alignmentOffset(legendWidth, lineWidths[cursor.line]);
                }
            }
            else if (i > 0 && y + itemHeight > me.top + me.minSize.height) {
                x = cursor.x = x + me.columnWidths[cursor.line] + labelOpts.padding;
                cursor.line++;
                y = cursor.y = me.top + alignmentOffset(legendHeight, columnHeights[cursor.line]);
            }
            drawLegendBox(x, y + boxTopOffset, legendItem);
            hitboxes[i].left = x;
            hitboxes[i].top = y;
            // Fill the actual label
            fillText(x, y, legendItem, textWidth);
            if (isHorizontal) {
                cursor.x += width + labelOpts.padding;
            }
            else {
                cursor.y += itemHeight;
            }
        }));
    }
}
/**
 * @return {?}
 */
export function monkeyPatchChartJsLegend() {
    /** @type {?} */
    const plugins = Chart.plugins.getAll();
    /** @type {?} */
    const legend = plugins.filter((/**
     * @param {?} p
     * @return {?}
     */
    p => p.id === 'legend'))[0];
    legend._element.prototype.fit = fit;
    legend._element.prototype.draw = draw;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibW9ua2V5LXBhdGNoLWNoYXJ0LWpzLWxlZ2VuZC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL25nMi1jaGFydHMvIiwic291cmNlcyI6WyJsaWIvbW9ua2V5LXBhdGNoLWNoYXJ0LWpzLWxlZ2VuZC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7TUFVTSxPQUFPLEdBQUcsS0FBSyxDQUFDLE9BQU87O01BQ3ZCLFFBQVEsR0FBRyxLQUFLLENBQUMsUUFBUTs7TUFDekIsY0FBYyxHQUFHLE9BQU8sQ0FBQyxjQUFjOzs7Ozs7QUFFN0MsU0FBUyxXQUFXLENBQUMsU0FBUyxFQUFFLFFBQVE7SUFDdEMsT0FBTyxTQUFTLENBQUMsYUFBYSxJQUFJLFNBQVMsQ0FBQyxRQUFRLEdBQUcsUUFBUSxDQUFDLENBQUM7UUFDL0QsUUFBUSxDQUFDLENBQUM7UUFDVixTQUFTLENBQUMsUUFBUSxDQUFDO0FBQ3ZCLENBQUM7Ozs7QUFFRCxTQUFTLEdBQUc7O1VBQ0osRUFBRSxHQUFHLElBQUk7O1VBQ1QsSUFBSSxHQUFHLEVBQUUsQ0FBQyxPQUFPOztVQUNqQixTQUFTLEdBQUcsSUFBSSxDQUFDLE1BQU07O1VBQ3ZCLE9BQU8sR0FBRyxJQUFJLENBQUMsT0FBTzs7VUFFdEIsR0FBRyxHQUFHLEVBQUUsQ0FBQyxHQUFHOztVQUVaLFNBQVMsR0FBRyxPQUFPLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxTQUFTLENBQUM7O1VBQ2pELFFBQVEsR0FBRyxTQUFTLENBQUMsSUFBSTs7O1VBR3pCLFFBQVEsR0FBRyxFQUFFLENBQUMsY0FBYyxHQUFHLEVBQUU7O1VBRWpDLE9BQU8sR0FBRyxFQUFFLENBQUMsT0FBTzs7VUFDcEIsWUFBWSxHQUFHLEVBQUUsQ0FBQyxZQUFZLEVBQUU7SUFFdEMsSUFBSSxZQUFZLEVBQUU7UUFDaEIsT0FBTyxDQUFDLEtBQUssR0FBRyxFQUFFLENBQUMsUUFBUSxDQUFDLENBQUMscUJBQXFCO1FBQ2xELE9BQU8sQ0FBQyxNQUFNLEdBQUcsT0FBTyxD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QUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsRUFBRSxLQUFLLFFBQVEsRUFBQyxDQUFDLENBQUMsQ0FBQztJQUN4RCxNQUFNLENBQUMsUUFBUSxDQUFDLFNBQVMsQ0FBQyxHQUFHLEdBQUcsR0FBRyxDQUFDO0lBQ3BDLE1BQU0sQ0FBQyxRQUFRLENBQUMsU0FBUyxDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7QUFDeEMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8vIHRzbGludDpkaXNhYmxlOnZhcmlhYmxlLW5hbWVcclxuXHJcbmRlY2xhcmUgY2xhc3MgQ2hhcnQge1xyXG4gIHN0YXRpYyByZWFkb25seSBDaGFydDogdHlwZW9mIENoYXJ0O1xyXG4gIHN0YXRpYyByZWFkb25seSBUb29sdGlwOiBhbnk7XHJcbiAgc3RhdGljIHJlYWRvbmx5IGhlbHBlcnM6IGFueTtcclxuICBzdGF0aWMgcmVhZG9ubHkgZGVmYXVsdHM6IGFueTtcclxuICBzdGF0aWMgcmVhZG9ubHkgcGx1Z2luczogYW55O1xyXG59XHJcblxyXG5jb25zdCBoZWxwZXJzID0gQ2hhcnQuaGVscGVycztcclxuY29uc3QgZGVmYXVsdHMgPSBDaGFydC5kZWZhdWx0cztcclxuY29uc3QgdmFsdWVPckRlZmF1bHQgPSBoZWxwZXJzLnZhbHVlT3JEZWZhdWx0O1xyXG5cclxuZnVuY3Rpb24gZ2V0Qm94V2lkdGgobGFiZWxPcHRzLCBmb250U2l6ZSkge1xyXG4gIHJldHVybiBsYWJlbE9wdHMudXNlUG9pbnRTdHlsZSAmJiBsYWJlbE9wdHMuYm94V2lkdGggPiBmb250U2l6ZSA/XHJcbiAgICBmb250U2l6ZSA6XHJcbiAgICBsYWJlbE9wdHMuYm94V2lkdGg7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGZpdCgpIHtcclxuICBjb25zdCBtZSA9IHRoaXM7XHJcbiAgY29uc3Qgb3B0cyA9IG1lLm9wdGlvbnM7XHJcbiAgY29uc3QgbGFiZWxPcHRzID0gb3B0cy5sYWJlbHM7XHJcbiAgY29uc3QgZGlzcGxheSA9IG9wdHMuZGlzcGxheTtcclxuXHJcbiAgY29uc3QgY3R4ID0gbWUuY3R4O1xyXG5cclxuICBjb25zdCBsYWJlbEZvbnQgPSBoZWxwZXJzLm9wdGlvbnMuX3BhcnNlRm9udChsYWJlbE9wdHMpO1xyXG4gIGNvbnN0IGZvbnRTaXplID0gbGFiZWxGb250LnNpemU7XHJcblxyXG4gIC8vIFJlc2V0IGhpdCBib3hlc1xyXG4gIGNvbnN0IGhpdGJveGVzID0gbWUubGVnZW5kSGl0Qm94ZXMgPSBbXTtcclxuXHJcbiAgY29uc3QgbWluU2l6ZSA9IG1lLm1pblNpemU7XHJcbiAgY29uc3QgaXNIb3Jpem9udGFsID0gbWUuaXNIb3Jpem9udGFsKCk7XHJcblxyXG4gIGlmIChpc0hvcml6b250YWwpIHtcclxuICAgIG1pblNpemUud2lkdGggPSBtZS5tYXhXaWR0aDsgLy8gZmlsbCBhbGwgdGhlIHdpZHRoXHJcbiAgICBtaW5TaXplLmhlaWdodCA9IGRpc3BsYXkgPyAxMCA6IDA7XHJcbiAgfSBlbHNlIHtcclxuICAgIG1pblNpemUud2lkdGggPSBkaXNwbGF5ID8gMTAgOiAwO1xyXG4gICAgbWluU2l6ZS5oZWlnaHQgPSBtZS5tYXhIZWlnaHQ7IC8vIGZpbGwgYWxsIHRoZSBoZWlnaHRcclxuICB9XHJcblxyXG4gIGNvbnN0IGdldE1heExpbmVXaWR0aCA9IHRleHRMaW5lcyA9PiB7XHJcbiAgICByZXR1cm4gdGV4dExpbmVzLm1hcCh0ZXh0TGluZSA9PiB7XHJcbiAgICAgIHJldHVybiBjdHgubWVhc3VyZVRleHQodGV4dExpbmUpLndpZHRoO1xyXG4gICAgfSkucmVkdWNlKChhY2MsIHYpID0+IHtcclxuICAgICAgcmV0dXJuIHYgPiBhY2MgPyB2IDogYWNjO1xyXG4gICAgfSwgMCk7XHJcbiAgfTtcclxuXHJcbiAgLy8gSW5jcmVhc2Ugc2l6ZXMgaGVyZVxyXG4gIGlmIChkaXNwbGF5KSB7XHJcbiAgICBjdHguZm9udCA9IGxhYmVsRm9udC5zdHJpbmc7XHJcblxyXG4gICAgaWYgKGlzSG9yaXpvbnRhbCkge1xyXG5cclxuICAgICAgLy8gTGFiZWxzXHJcblxyXG4gICAgICAvLyBXaWR0aCBvZiBlYWNoIGxpbmUgb2YgbGVnZW5kIGJveGVzLiBMYWJlbHMgd3JhcCBvbnRvIG11bHRpcGxlIGxpbmVzIHdoZW4gdGhlcmUgYXJlIHRvbyBtYW55IHRvIGZpdCBvbiBvbmVcclxuICAgICAgY29uc3QgbGluZVdpZHRocyA9IG1lLmxpbmVXaWR0aHMgPSBbMF07XHJcbiAgICAgIGxldCBtYXhIZWlnaHQgPSAwO1xyXG4gICAgICBsZXQgdG90YWxIZWlnaHQgPSAwO1xyXG5cclxuICAgICAgY3R4LnRleHRBbGlnbiA9ICdsZWZ0JztcclxuICAgICAgY3R4LnRleHRCYXNlbGluZSA9ICd0b3AnO1xyXG5cclxuICAgICAgaGVscGVycy5lYWNoKG1lLmxlZ2VuZEl0ZW1zLCAobGVnZW5kSXRlbSwgaSkgPT4ge1xyXG4gICAgICAgIGxldCB3aWR0aDtcclxuICAgICAgICBsZXQgaGVpZ2h0O1xyXG4gICAgICAgIGxldCBncm9zc0hlaWdodDtcclxuXHJcbiAgICAgICAgaWYgKGhlbHBlcnMuaXNBcnJheShsZWdlbmRJdGVtLnRleHQpKSB7XHJcbiAgICAgICAgICB3aWR0aCA9IGdldE1heExpbmVXaWR0aChsZWdlbmRJdGVtLnRleHQpO1xyXG4gICAgICAgICAgaGVpZ2h0ID0gZm9udFNpemUgKiBsZWdlbmRJdGVtLnRleHQubGVuZ3RoO1xyXG4gICAgICAgICAgZ3Jvc3NIZWlnaHQgPSBoZWlnaHQ7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIHdpZHRoID0gY3R4Lm1lYXN1cmVUZXh0KGxlZ2VuZEl0ZW0udGV4dCkud2lkdGg7XHJcbiAgICAgICAgICBoZWlnaHQgPSBmb250U2l6ZTtcclxuICAgICAgICAgIGdyb3NzSGVpZ2h0ID0gaGVpZ2h0ICsgbGFiZWxPcHRzLnBhZGRpbmc7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHdpZHRoICs9IGdldEJveFdpZHRoKGxhYmVsT3B0cywgZm9udFNpemUpICsgKGZvbnRTaXplIC8gMik7XHJcblxyXG4gICAgICAgIGlmIChncm9zc0hlaWdodCA+IG1heEhlaWdodCkge1xyXG4gICAgICAgICAgbWF4SGVpZ2h0ID0gZ3Jvc3NIZWlnaHQ7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAobGluZVdpZHRoc1tsaW5lV2lkdGhzLmxlbmd0aCAtIDFdICsgd2lkdGggKyAyICogbGFiZWxPcHRzLnBhZGRpbmcgPiBtaW5TaXplLndpZHRoKSB7XHJcbiAgICAgICAgICB0b3RhbEhlaWdodCArPSBtYXhIZWlnaHQ7XHJcbiAgICAgICAgICBtYXhIZWlnaHQgPSAwO1xyXG4gICAgICAgICAgbGluZVdpZHRoc1tsaW5lV2lkdGhzLmxlbmd0aCAtIChpID4gMCA/IDAgOiAxKV0gPSAwO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gU3RvcmUgdGhlIGhpdGJveCB3aWR0aCBhbmQgaGVpZ2h0IGhlcmUuIEZpbmFsIHBvc2l0aW9uIHdpbGwgYmUgdXBkYXRlZCBpbiBgZHJhd2BcclxuICAgICAgICBoaXRib3hlc1tpXSA9IHtcclxuICAgICAgICAgIGxlZnQ6IDAsXHJcbiAgICAgICAgICB0b3A6IDAsXHJcbiAgICAgICAgICB3aWR0aCxcclxuICAgICAgICAgIGhlaWdodCxcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICBsaW5lV2lkdGhzW2xpbmVXaWR0aHMubGVuZ3RoIC0gMV0gKz0gd2lkdGggKyBsYWJlbE9wdHMucGFkZGluZztcclxuICAgICAgfSk7XHJcblxyXG4gICAgICBtaW5TaXplLmhlaWdodCArPSB0b3RhbEhlaWdodCArIG1heEhlaWdodDtcclxuXHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBjb25zdCB2UGFkZGluZyA9IGxhYmVsT3B0cy5wYWRkaW5nO1xyXG4gICAgICBjb25zdCBjb2x1bW5XaWR0aHMgPSBtZS5jb2x1bW5XaWR0aHMgPSBbXTtcclxuICAgICAgY29uc3QgY29sdW1uSGVpZ2h0cyA9IG1lLmNvbHVtbkhlaWdodHMgPSBbXTtcclxuICAgICAgbGV0IHRvdGFsV2lkdGggPSBsYWJlbE9wdHMucGFkZGluZztcclxuICAgICAgbGV0IGN1cnJlbnRDb2xXaWR0aCA9IDA7XHJcbiAgICAgIGxldCBjdXJyZW50Q29sSGVpZ2h0ID0gMDtcclxuXHJcbiAgICAgIGhlbHBlcnMuZWFjaChtZS5sZWdlbmRJdGVtcywgKGxlZ2VuZEl0ZW0sIGkpID0+IHtcclxuICAgICAgICBsZXQgaXRlbVdpZHRoO1xyXG4gICAgICAgIGxldCBoZWlnaHQ7XHJcblxyXG4gICAgICAgIGlmIChoZWxwZXJzLmlzQXJyYXkobGVnZW5kSXRlbS50ZXh0KSkge1xyXG4gICAgICAgICAgaXRlbVdpZHRoID0gZ2V0TWF4TGluZVdpZHRoKGxlZ2VuZEl0ZW0udGV4dCk7XHJcbiAgICAgICAgICBoZWlnaHQgPSBmb250U2l6ZSAqIGxlZ2VuZEl0ZW0udGV4dC5sZW5ndGg7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIGl0ZW1XaWR0aCA9IGN0eC5tZWFzdXJlVGV4dChsZWdlbmRJdGVtLnRleHQpLndpZHRoO1xyXG4gICAgICAgICAgaGVpZ2h0ID0gZm9udFNpemU7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGl0ZW1XaWR0aCArPSBnZXRCb3hXaWR0aChsYWJlbE9wdHMsIGZvbnRTaXplKSArIChmb250U2l6ZSAvIDIpO1xyXG5cclxuICAgICAgICAvLyBJZiB0b28gdGFsbCwgZ28gdG8gbmV3IGNvbHVtblxyXG4gICAgICAgIGlmIChpID4gMCAmJiBjdXJyZW50Q29sSGVpZ2h0ICsgZm9udFNpemUgKyAyICogdlBhZGRpbmcgPiBtaW5TaXplLmhlaWdodCkge1xyXG4gICAgICAgICAgdG90YWxXaWR0aCArPSBjdXJyZW50Q29sV2lkdGggKyBsYWJlbE9wdHMucGFkZGluZztcclxuICAgICAgICAgIGNvbHVtbldpZHRocy5wdXNoKGN1cnJlbnRDb2xXaWR0aCk7IC8vIHByZXZpb3VzIGNvbHVtbiB3aWR0aFxyXG4gICAgICAgICAgY29sdW1uSGVpZ2h0cy5wdXNoKGN1cnJlbnRDb2xIZWlnaHQpO1xyXG4gICAgICAgICAgY3VycmVudENvbFdpZHRoID0gMDtcclxuICAgICAgICAgIGN1cnJlbnRDb2xIZWlnaHQgPSAwO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gR2V0IG1heCB3aWR0aFxyXG4gICAgICAgIGN1cnJlbnRDb2xXaWR0aCA9IE1hdGgubWF4KGN1cnJlbnRDb2xXaWR0aCwgaXRlbVdpZHRoKTtcclxuICAgICAgICBjdXJyZW50Q29sSGVpZ2h0ICs9IGZvbnRTaXplICsgdlBhZGRpbmc7XHJcblxyXG4gICAgICAgIC8vIFN0b3JlIHRoZSBoaXRib3ggd2lkdGggYW5kIGhlaWdodCBoZXJlLiBGaW5hbCBwb3NpdGlvbiB3aWxsIGJlIHVwZGF0ZWQgaW4gYGRyYXdgXHJcbiAgICAgICAgaGl0Ym94ZXNbaV0gPSB7XHJcbiAgICAgICAgICBsZWZ0OiAwLFxyXG4gICAgICAgICAgdG9wOiAwLFxyXG4gICAgICAgICAgd2lkdGg6IGl0ZW1XaWR0aCxcclxuICAgICAgICAgIGhlaWdodFxyXG4gICAgICAgIH07XHJcbiAgICAgIH0pO1xyXG5cclxuICAgICAgdG90YWxXaWR0aCArPSBjdXJyZW50Q29sV2lkdGg7XHJcbiAgICAgIGNvbHVtbldpZHRocy5wdXNoKGN1cnJlbnRDb2xXaWR0aCk7XHJcbiAgICAgIGNvbHVtbkhlaWdodHMucHVzaChjdXJyZW50Q29sSGVpZ2h0KTtcclxuICAgICAgbWluU2l6ZS53aWR0aCArPSB0b3RhbFdpZHRoO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgbWUud2lkdGggPSBtaW5TaXplLndpZHRoO1xyXG4gIG1lLmhlaWdodCA9IG1pblNpemUuaGVpZ2h0O1xyXG59XHJcblxyXG5mdW5jdGlvbiBnZXRBbGlnbmVkWCh2bSwgYWxpZ24pIHtcclxuICByZXR1cm4gYWxpZ24gPT09ICdjZW50ZXInXHJcbiAgICA/IHZtLnggKyB2bS53aWR0aCAvIDJcclxuICAgIDogYWxpZ24gPT09ICdyaWdodCdcclxuICAgICAgPyB2bS54ICsgdm0ud2lkdGggLSB2bS54UGFkZGluZ1xyXG4gICAgICA6IHZtLnggKyB2bS54UGFkZGluZztcclxufVxyXG5cclxuZnVuY3Rpb24gZHJhdygpIHtcclxuICBjb25zdCBtZSA9IHRoaXM7XHJcbiAgY29uc3Qgb3B0cyA9IG1lLm9wdGlvbnM7XHJcbiAgY29uc3QgbGFiZWxPcHRzID0gb3B0cy5sYWJlbHM7XHJcbiAgY29uc3QgZ2xvYmFsRGVmYXVsdHMgPSBkZWZhdWx0cy5nbG9iYWw7XHJcbiAgY29uc3QgZGVmYXVsdENvbG9yID0gZ2xvYmFsRGVmYXVsdHMuZGVmYXVsdENvbG9yO1xyXG4gIGNvbnN0IGxpbmVEZWZhdWx0ID0gZ2xvYmFsRGVmYXVsdHMuZWxlbWVudHMubGluZTtcclxuICBjb25zdCBsZWdlbmRIZWlnaHQgPSBtZS5oZWlnaHQ7XHJcbiAgY29uc3QgY29sdW1uSGVpZ2h0cyA9IG1lLmNvbHVtbkhlaWdodHM7XHJcbiAgY29uc3QgbGVnZW5kV2lkdGggPSBtZS53aWR0aDtcclxuICBjb25zdCBsaW5lV2lkdGhzID0gbWUubGluZVdpZHRocztcclxuXHJcbiAgaWYgKG9wdHMuZGlzcGxheSkge1xyXG4gICAgY29uc3QgY3R4ID0gbWUuY3R4O1xyXG4gICAgY29uc3QgZm9udENvbG9yID0gdmFsdWVPckRlZmF1bHQobGFiZWxPcHRzLmZvbnRDb2xvciwgZ2xvYmFsRGVmYXVsdHMuZGVmYXVsdEZvbnRDb2xvcik7XHJcbiAgICBjb25zdCBsYWJlbEZvbnQgPSBoZWxwZXJzLm9wdGlvbnMuX3BhcnNlRm9udChsYWJlbE9wdHMpO1xyXG4gICAgY29uc3QgZm9udFNpemUgPSBsYWJlbEZvbnQuc2l6ZTtcclxuICAgIGxldCBjdXJzb3I7XHJcblxyXG4gICAgLy8gQ2FudmFzIHNldHVwXHJcbiAgICBjdHgudGV4dEFsaWduID0gJ2xlZnQnO1xyXG4gICAgY3R4LnRleHRCYXNlbGluZSA9ICdtaWRkbGUnO1xyXG4gICAgY3R4LmxpbmVXaWR0aCA9IDAuNTtcclxuICAgIGN0eC5zdHJva2VTdHlsZSA9IGZvbnRDb2xvcjsgLy8gZm9yIHN0cmlrZXRocm91Z2ggZWZmZWN0XHJcbiAgICBjdHguZmlsbFN0eWxlID0gZm9udENvbG9yOyAvLyByZW5kZXIgaW4gY29ycmVjdCBjb2xvdXJcclxuICAgIGN0eC5mb250ID0gbGFiZWxGb250LnN0cmluZztcclxuXHJcbiAgICBjb25zdCBib3hXaWR0aCA9IGdldEJveFdpZHRoKGxhYmVsT3B0cywgZm9udFNpemUpO1xyXG4gICAgY29uc3QgaGl0Ym94ZXMgPSBtZS5sZWdlbmRIaXRCb3hlcztcclxuXHJcbiAgICBjb25zdCBtYXhIZWlnaHQgPSBoaXRib3hlcy5tYXAoeCA9PiB7XHJcbiAgICAgIHJldHVybiB4LmhlaWdodDtcclxuICAgIH0pLnJlZHVjZSgoYWNjLCB2KSA9PiB7XHJcbiAgICAgIHJldHVybiB2ID4gYWNjID8gdiA6IGFjYztcclxuICAgIH0sIDApO1xyXG5cclxuICAgIC8vIGN1cnJlbnQgcG9zaXRpb25cclxuICAgIGNvbnN0IGRyYXdMZWdlbmRCb3ggPSAoeCwgeSwgbGVnZW5kSXRlbSkgPT4ge1xyXG4gICAgICBpZiAoaXNOYU4oYm94V2lkdGgpIHx8IGJveFdpZHRoIDw9IDApIHtcclxuICAgICAgICByZXR1cm47XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIC8vIFNldCB0aGUgY3R4IGZvciB0aGUgYm94XHJcbiAgICAgIGN0eC5zYXZlKCk7XHJcblxyXG4gICAgICBjb25zdCBsaW5lV2lkdGggPSB2YWx1ZU9yRGVmYXVsdChsZWdlbmRJdGVtLmxpbmVXaWR0aCwgbGluZURlZmF1bHQuYm9yZGVyV2lkdGgpO1xyXG4gICAgICBjdHguZmlsbFN0eWxlID0gdmFsdWVPckRlZmF1bHQobGVnZW5kSXRlbS5maWxsU3R5bGUsIGRlZmF1bHRDb2xvcik7XHJcbiAgICAgIGN0eC5saW5lQ2FwID0gdmFsdWVPckRlZmF1bHQobGVnZW5kSXRlbS5saW5lQ2FwLCBsaW5lRGVmYXVsdC5ib3JkZXJDYXBTdHlsZSk7XHJcbiAgICAgIGN0eC5saW5lRGFzaE9mZnNldCA9IHZhbHVlT3JEZWZhdWx0KGxlZ2VuZEl0ZW0ubGluZURhc2hPZmZzZXQsIGxpbmVEZWZhdWx0LmJvcmRlckRhc2hPZmZzZXQpO1xyXG4gICAgICBjdHgubGluZUpvaW4gPSB2YWx1ZU9yRGVmYXVsdChsZWdlbmRJdGVtLmxpbmVKb2luLCBsaW5lRGVmYXVsdC5ib3JkZXJKb2luU3R5bGUpO1xyXG4gICAgICBjdHgubGluZVdpZHRoID0gbGluZVdpZHRoO1xyXG4gICAgICBjdHguc3Ryb2tlU3R5bGUgPSB2YWx1ZU9yRGVmYXVsdChsZWdlbmRJdGVtLnN0cm9rZVN0eWxlLCBkZWZhdWx0Q29sb3IpO1xyXG5cclxuICAgICAgaWYgKGN0eC5zZXRMaW5lRGFzaCkge1xyXG4gICAgICAgIC8vIElFIDkgYW5kIDEwIGRvIG5vdCBzdXBwb3J0IGxpbmUgZGFzaFxyXG4gICAgICAgIGN0eC5zZXRMaW5lRGFzaCh2YWx1ZU9yRGVmYXVsdChsZWdlbmRJdGVtLmxpbmVEYXNoLCBsaW5lRGVmYXVsdC5ib3JkZXJEYXNoKSk7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIGlmIChvcHRzLmxhYmVscyAmJiBvcHRzLmxhYmVscy51c2VQb2ludFN0eWxlKSB7XHJcbiAgICAgICAgLy8gUmVjYWxjdWxhdGUgeCBhbmQgeSBmb3IgZHJhd1BvaW50KCkgYmVjYXVzZSBpdHMgZXhwZWN0aW5nXHJcbiAgICAgICAgLy8geCBhbmQgeSB0byBiZSBjZW50ZXIgb2YgZmlndXJlIChpbnN0ZWFkIG9mIHRvcCBsZWZ0KVxyXG4gICAgICAgIGNvbnN0IHJhZGl1cyA9IGJveFdpZHRoICogTWF0aC5TUVJUMiAvIDI7XHJcbiAgICAgICAgY29uc3QgY2VudGVyWCA9IHggKyBib3hXaWR0aCAvIDI7XHJcbiAgICAgICAgY29uc3QgY2VudGVyWSA9IHkgKyBmb250U2l6ZSAvIDI7XHJcblxyXG4gICAgICAgIC8vIERyYXcgcG9pbnRTdHlsZSBhcyBsZWdlbmQgc3ltYm9sXHJcbiAgICAgICAgaGVscGVycy5jYW52YXMuZHJhd1BvaW50KGN0eCwgbGVnZW5kSXRlbS5wb2ludFN0eWxlLCByYWRpdXMsIGNlbnRlclgsIGNlbnRlclkpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIC8vIERyYXcgYm94IGFzIGxlZ2VuZCBzeW1ib2xcclxuICAgICAgICBpZiAobGluZVdpZHRoICE9PSAwKSB7XHJcbiAgICAgICAgICBjdHguc3Ryb2tlUmVjdCh4LCB5LCBib3hXaWR0aCwgZm9udFNpemUpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjdHguZmlsbFJlY3QoeCwgeSwgYm94V2lkdGgsIGZvbnRTaXplKTtcclxuICAgICAgfVxyXG5cclxuICAgICAgY3R4LnJlc3RvcmUoKTtcclxuICAgIH07XHJcblxyXG4gICAgY29uc3QgZHJhd1N0cmlrZVRocm91Z2ggPSAoeCwgeSwgdykgPT4ge1xyXG4gICAgICBjdHguYmVnaW5QYXRoKCk7XHJcbiAgICAgIGN0eC5saW5lV2lkdGggPSAyO1xyXG4gICAgICBjdHgubW92ZVRvKHgsIHkpO1xyXG4gICAgICBjdHgubGluZVRvKHggKyB3LCB5KTtcclxuICAgICAgY3R4LnN0cm9rZSgpO1xyXG4gICAgfTtcclxuXHJcbiAgICBjb25zdCBkcmF3Q3Jvc3NPdmVyID0gKHgsIHksIHcsIGgpID0+IHtcclxuICAgICAgY3R4LmJlZ2luUGF0aCgpO1xyXG4gICAgICBjdHgubGluZVdpZHRoID0gMjtcclxuICAgICAgY3R4Lm1vdmVUbyh4LCB5KTtcclxuICAgICAgY3R4LmxpbmVUbyh4ICsgdywgeSArIGgpO1xyXG4gICAgICBjdHgubW92ZVRvKHgsIHkgKyBoKTtcclxuICAgICAgY3R4LmxpbmVUbyh4ICsgdywgeSk7XHJcbiAgICAgIGN0eC5zdHJva2UoKTtcclxuICAgIH07XHJcblxyXG4gICAgY29uc3QgZmlsbFRleHQgPSAoeCwgeSwgbGVnZW5kSXRlbSwgdGV4dFdpZHRoKSA9PiB7XHJcbiAgICAgIGNvbnN0IGhhbGZGb250U2l6ZSA9IGZvbnRTaXplIC8gMjtcclxuICAgICAgY29uc3QgeExlZnQgPSBib3hXaWR0aCArIGhhbGZGb250U2l6ZSArIHg7XHJcbiAgICAgIGNvbnN0IHlNaWRkbGUgPSB5ICsgaGFsZkZvbnRTaXplO1xyXG5cclxuICAgICAgaWYgKGhlbHBlcnMuaXNBcnJheShsZWdlbmRJdGVtLnRleHQpKSB7XHJcbiAgICAgICAgaGVscGVycy5lYWNoKGxlZ2VuZEl0ZW0udGV4dCwgKHRleHRMaW5lLCBpbmRleCkgPT4ge1xyXG4gICAgICAgICAgY29uc3QgbGluZU9mZnNldCA9IGluZGV4ICogZm9udFNpemU7XHJcbiAgICAgICAgICBjdHguZmlsbFRleHQodGV4dExpbmUsIHhMZWZ0LCB5TWlkZGxlICsgbGluZU9mZnNldCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgY3R4LmZpbGxUZXh0KGxlZ2VuZEl0ZW0udGV4dCwgeExlZnQsIHlNaWRkbGUpO1xyXG4gICAgICB9XHJcblxyXG4gICAgICBpZiAobGVnZW5kSXRlbS5oaWRkZW4pIHtcclxuICAgICAgICBpZiAoaGVscGVycy5pc0FycmF5KGxlZ2VuZEl0ZW0udGV4dCkpIHtcclxuICAgICAgICAgIGRyYXdDcm9zc092ZXIoeExlZnQsIHlNaWRkbGUsIHRleHRXaWR0aCwgKGxlZ2VuZEl0ZW0udGV4dC5sZW5ndGggLSAxKSAqIChmb250U2l6ZSAtIDEpKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgZHJhd1N0cmlrZVRocm91Z2goeExlZnQsIHlNaWRkbGUsIHRleHRXaWR0aCk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9O1xyXG5cclxuICAgIGNvbnN0IGFsaWdubWVudE9mZnNldCA9IChkaW1lbnNpb24sIGJsb2NrU2l6ZSkgPT4ge1xyXG4gICAgICBzd2l0Y2ggKG9wdHMuYWxpZ24pIHtcclxuICAgICAgY2FzZSAnc3RhcnQnOlxyXG4gICAgICAgIHJldHVybiBsYWJlbE9wdHMucGFkZGluZztcclxuICAgICAgY2FzZSAnZW5kJzpcclxuICAgICAgICByZXR1cm4gZGltZW5zaW9uIC0gYmxvY2tTaXplO1xyXG4gICAgICBkZWZhdWx0OiAvLyBjZW50ZXJcclxuICAgICAgICByZXR1cm4gKGRpbWVuc2lvbiAtIGJsb2NrU2l6ZSArIGxhYmVsT3B0cy5wYWRkaW5nKSAvIDI7XHJcbiAgICAgIH1cclxuICAgIH07XHJcblxyXG4gICAgLy8gSG9yaXpvbnRhbFxyXG4gICAgY29uc3QgaXNIb3Jpem9udGFsID0gbWUuaXNIb3Jpem9udGFsKCk7XHJcbiAgICBpZiAoaXNIb3Jpem9udGFsKSB7XHJcbiAgICAgIGN1cnNvciA9IHtcclxuICAgICAgICB4OiBtZS5sZWZ0ICsgYWxpZ25tZW50T2Zmc2V0KGxlZ2VuZFdpZHRoLCBsaW5lV2lkdGhzWzBdKSxcclxuICAgICAgICB5OiBtZS50b3AgKyBsYWJlbE9wdHMucGFkZGluZyxcclxuICAgICAgICBsaW5lOiAwXHJcbiAgICAgIH07XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBjdXJzb3IgPSB7XHJcbiAgICAgICAgeDogbWUubGVmdCArIGxhYmVsT3B0cy5wYWRkaW5nLFxyXG4gICAgICAgIHk6IG1lLnRvcCArIGFsaWdubWVudE9mZnNldChsZWdlbmRIZWlnaHQsIGNvbHVtbkhlaWdodHNbMF0pLFxyXG4gICAgICAgIGxpbmU6IDBcclxuICAgICAgfTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBpdGVtSGVpZ2h0ID0gbWF4SGVpZ2h0O1xyXG4gICAgaGVscGVycy5lYWNoKG1lLmxlZ2VuZEl0ZW1zLCAobGVnZW5kSXRlbSwgaSkgPT4ge1xyXG4gICAgICBsZXQgdGV4dFdpZHRoO1xyXG4gICAgICBsZXQgYm94VG9wT2Zmc2V0O1xyXG5cclxuICAgICAgaWYgKGhlbHBlcnMuaXNBcnJheShsZWdlbmRJdGVtLnRleHQpKSB7XHJcbiAgICAgICAgdGV4dFdpZHRoID0gbGVnZW5kSXRlbS50ZXh0Lm1hcCh0ZXh0TGluZSA9PiB7XHJcbiAgICAgICAgICByZXR1cm4gY3R4Lm1lYXN1cmVUZXh0KHRleHRMaW5lKS53aWR0aDtcclxuICAgICAgICB9KS5yZWR1Y2UoKGFjYywgdikgPT4ge1xyXG4gICAgICAgICAgcmV0dXJuIHYgPiBhY2MgPyB2IDogYWNjO1xyXG4gICAgICAgIH0sIDApO1xyXG4gICAgICAgIGJveFRvcE9mZnNldCA9IGZvbnRTaXplIC8gMiAqIChsZWdlbmRJdGVtLnRleHQubGVuZ3RoIC0gMSk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgdGV4dFdpZHRoID0gY3R4Lm1lYXN1cmVUZXh0KGxlZ2VuZEl0ZW0udGV4dCkud2lkdGg7XHJcbiAgICAgICAgYm94VG9wT2Zmc2V0ID0gMDtcclxuICAgICAgfVxyXG5cclxuICAgICAgY29uc3Qgd2lkdGggPSBib3hXaWR0aCArIChmb250U2l6ZSAvIDIpICsgdGV4dFdpZHRoO1xyXG4gICAgICBsZXQgeCA9IGN1cnNvci54O1xyXG4gICAgICBjb25zdCB0b3BPZmZzZXQgPSBNYXRoLnRydW5jKChtYXhIZWlnaHQgLSBoaXRib3hlc1tpXS5oZWlnaHQpIC8gMik7XHJcbiAgICAgIGxldCB5ID0gY3Vyc29yLnkgKyB0b3BPZmZzZXQ7XHJcblxyXG4gICAgICAvLyBVc2UgKG1lLmxlZnQgKyBtZS5taW5TaXplLndpZHRoKSBhbmQgKG1lLnRvcCArIG1lLm1pblNpemUuaGVpZ2h0KVxyXG4gICAgICAvLyBpbnN0ZWFkIG9mIG1lLnJpZ2h0IGFuZCBtZS5ib3R0b20gYmVjYXVzZSBtZS53aWR0aCBhbmQgbWUuaGVpZ2h0XHJcbiAgICAgIC8vIG1heSBoYXZlIGJlZW4gY2hhbmdlZCBzaW5jZSBtZS5taW5TaXplIHdhcyBjYWxjdWxhdGVkXHJcbiAgICAgIGlmIChpc0hvcml6b250YWwpIHtcclxuICAgICAgICBpZiAoaSA+IDAgJiYgeCArIHdpZHRoICsgbGFiZWxPcHRzLnBhZGRpbmcgPiBtZS5sZWZ0ICsgbWUubWluU2l6ZS53aWR0aCkge1xyXG4gICAgICAgICAgeSA9IGN1cnNvci55ICs9IGl0ZW1IZWlnaHQ7XHJcbiAgICAgICAgICBjdXJzb3IubGluZSsrO1xyXG4gICAgICAgICAgeCA9IGN1cnNvci54ID0gbWUubGVmdCArIGFsaWdubWVudE9mZnNldChsZWdlbmRXaWR0aCwgbGluZVdpZHRoc1tjdXJzb3IubGluZV0pO1xyXG4gICAgICAgIH1cclxuICAgICAgfSBlbHNlIGlmIChpID4gMCAmJiB5ICsgaXRlbUhlaWdodCA+IG1lLnRvcCArIG1lLm1pblNpemUuaGVpZ2h0KSB7XHJcbiAgICAgICAgeCA9IGN1cnNvci54ID0geCArIG1lLmNvbHVtbldpZHRoc1tjdXJzb3IubGluZV0gKyBsYWJlbE9wdHMucGFkZGluZztcclxuICAgICAgICBjdXJzb3IubGluZSsrO1xyXG4gICAgICAgIHkgPSBjdXJzb3IueSA9IG1lLnRvcCArIGFsaWdubWVudE9mZnNldChsZWdlbmRIZWlnaHQsIGNvbHVtbkhlaWdodHNbY3Vyc29yLmxpbmVdKTtcclxuICAgICAgfVxyXG5cclxuICAgICAgZHJhd0xlZ2VuZEJveCh4LCB5ICsgYm94VG9wT2Zmc2V0LCBsZWdlbmRJdGVtKTtcclxuXHJcbiAgICAgIGhpdGJveGVzW2ldLmxlZnQgPSB4O1xyXG4gICAgICBoaXRib3hlc1tpXS50b3AgPSB5O1xyXG5cclxuICAgICAgLy8gRmlsbCB0aGUgYWN0dWFsIGxhYmVsXHJcbiAgICAgIGZpbGxUZXh0KHgsIHksIGxlZ2VuZEl0ZW0sIHRleHRXaWR0aCk7XHJcblxyXG4gICAgICBpZiAoaXNIb3Jpem9udGFsKSB7XHJcbiAgICAgICAgY3Vyc29yLnggKz0gd2lkdGggKyBsYWJlbE9wdHMucGFkZGluZztcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBjdXJzb3IueSArPSBpdGVtSGVpZ2h0O1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBtb25rZXlQYXRjaENoYXJ0SnNMZWdlbmQoKSB7XHJcbiAgY29uc3QgcGx1Z2lucyA9IENoYXJ0LnBsdWdpbnMuZ2V0QWxsKCk7XHJcbiAgY29uc3QgbGVnZW5kID0gcGx1Z2lucy5maWx0ZXIocCA9PiBwLmlkID09PSAnbGVnZW5kJylbMF07XHJcbiAgbGVnZW5kLl9lbGVtZW50LnByb3RvdHlwZS5maXQgPSBmaXQ7XHJcbiAgbGVnZW5kLl9lbGVtZW50LnByb3RvdHlwZS5kcmF3ID0gZHJhdztcclxufVxyXG4iXX0=